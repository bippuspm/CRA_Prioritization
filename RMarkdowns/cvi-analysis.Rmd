---
title: "CVI"
author: "Paige Varner"
date: "2023-09-21"
output: html_document
---

#load libraries
```{r}
library("dplyr")
library("bigrquery")
library("DBI")
library("pheatmap")
library("RColorBrewer")
library("Rmisc")
library("stats")
library("rstatix")
library("ggplot2")
library("tigris")
library("sf")
library("tidycensus")
library("viridis")
```


#query data from BQ (dataframe with TRI ID, facility name, chemicals, lat/long, and total sum of on site releases for the 5 year span)
```{r}
	# set up database connection
	con <- dbConnect(
	  bigrquery::bigquery(),
	  project = "edf-aq-data",
	  dataset = "tri",
)

SQL = "	
	SELECT
	trifd,
	facility_name,
	chemical,
	latitude,
	longitude,
	SUM(on_site_release_total) as sum_onsite_releases
	FROM `edf-aq-data.tri.tri_basic_2016-2021` 
	GROUP BY trifd, facility_name, chemical,latitude,longitude"

tri = dbGetQuery(con,SQL)

tri = filter(tri, sum_onsite_releases > 0)
```


#get census tract GEOIDs for all TRI facilities based on long/lat
```{r}
cvi = read.csv("~/TSCA/CRA/CRA_Prioritization/Data/cvi_scores.csv")
colnames(cvi)[1] = "GEOID"

#getting census tract info for all TRI facilities
tracts = tracts(state = NULL, cb = TRUE)

tri.points <- tri %>%
  filter(!is.na(latitude)) %>%  # remove missing
  st_as_sf(coords=c('longitude', 'latitude'), crs=st_crs(tracts))

tri.tracts = st_join(tri.points, tracts)
```


#join CVI data to TRI data based on GEOID
```{r}
tri_cvi = merge(tri.tracts, cvi, by = "GEOID")
```


#fix multiple chemical names
```{r}
tri_cvi$chemical = gsub("Hydrogen cyanide", "Cyanide compounds", tri_cvi$chemical)
tri_cvi$chemical = gsub("m-Xylene", "Xylene (mixed isomers)", tri_cvi$chemical)
tri_cvi$chemical = gsub("o-Xylene", "Xylene (mixed isomers)", tri_cvi$chemical)
tri_cvi$chemical = gsub("p-Xylene", "Xylene (mixed isomers)", tri_cvi$chemical)
tri_cvi$chemical = gsub("Cadmium compounds", "Cadmium", tri_cvi$chemical)
tri_cvi$chemical = gsub("Arsenic compounds", "Arsenic", tri_cvi$chemical)
tri_cvi$chemical = gsub("Nickel compounds", "Nickel", tri_cvi$chemical)
tri_cvi$chemical = gsub("Lead compounds", "Lead", tri_cvi$chemical)
tri_cvi$chemical = gsub("Barium compounds", "Barium", tri_cvi$chemical)
tri_cvi$chemical = gsub("Cobalt compounds", "Cobalt", tri_cvi$chemical)
tri_cvi$chemical = gsub("Chromium compounds", "Chromium", tri_cvi$chemical)
tri_cvi$chemical = gsub("Nonylphenol Ethoxylates", "Nonylphenol", tri_cvi$chemical)


tri_cvi = tri_cvi[!duplicated(tri_cvi[c("trifd", "chemical")]),]

write.csv(tri_cvi, "~/TSCA/CRA/CRA_Prioritization/Data/tri_cvi.csv")
```



#Get average baseline CVI score for each chemical and endpoint group
```{r}
baseline_bychem = summarySE(tri_cvi, groupvars = "chemical", measurevar = "Baseline.Vulnerabilities")

baseline_CNS = filter(baseline_bychem, chemical == "Acetaldehyde" | chemical == "Acrylonitrile"|chemical == "Aniline"|chemical == "Styrene"|chemical == "Benzene"|chemical == "Bromoform"|chemical == "Vinyl chloride"|chemical =="Arsenic"|chemical =="Arsenic compounds"|chemical == "Cyanide compounds" | chemical == "Hydrogen cyanide" |  chemical == "Ethylbenzene" | chemical == "m-Xylene" | chemical == "o-Xylene" | chemical == "p-Xylene" | chemical == "Xylene (mixed isomers)"| chemical =="Decabromodiphenyl oxide"| chemical == "Lead"| chemical == "Lead compounds") 

baseline_carc = filter(baseline_bychem, chemical == "Acetaldehyde" | chemical == "Acrylonitrile"|chemical == "Aniline"|chemical == "Styrene"|chemical == "Benzene"|chemical == "Bromoform"|chemical == "Vinyl chloride"|chemical == "Creosote"|chemical == "3,3'-Dichlorobenzidine"|chemical == "3,3'-Dichlorobenzidine dihydrochloride"|chemical == "4,4'-Methylenebis(2-chloroaniline)"|chemical == "N-Nitrosodiphenylamine"|chemical == "Cadmium" | chemical == "Cadmium compounds"|chemical == "Nickel" | chemical == "Nickel compounds"|chemical == "Arsenic" | chemical == "Arsenic compounds"|chemical == "Chromium" | chemical == "Chromium compounds"|chemical == "Lead" | chemical == "Lead compounds")

baseline_cardio = filter(baseline_bychem, chemical == "Barium" | chemical == "Barium compounds"|chemical == "Cobalt" | chemical == "Cobalt compounds"|chemical == "Molybdenum trioxide"|chemical == "Naphthalene"|chemical == "Maleic anhydride"|chemical == "1-Hexadecanol"|chemical == "Hydrogen fluoride"|chemical == "Acetaldehyde" | chemical == "Acrylonitrile"|chemical == "Arsenic" | chemical == "Arsenic compounds"|chemical == "Aniline"|chemical == "Cadmium" | chemical == "Cadmium compounds"|chemical == "Chromium" | chemical == "Chromium compounds"|chemical =="Ethylbenzene"|chemical == "Nickel" | chemical == "Nickel compounds")

baseline_lkt = filter(baseline_bychem, chemical == "Hexachloro-1,3-butadiene"|chemical == "Maleic anhydride"|chemical == "4,4'-Methylenebis(2-chloroaniline)"|chemical == "Cadmium" | chemical == "Cadmium compounds"|chemical == "Creosote"|chemical =="Ethylbenzene"|chemical == "Lead" | chemical == "Lead compounds"|chemical == "Molybdenum trioxide"|chemical == "Styrene"|chemical == "Bromoform"|chemical == "Vinyl chloride")

baseline_edc = filter(baseline_bychem, chemical == "Nonylphenol" | chemical == "Nonylphenol Ethoxylates"|chemical == "4,4'-Isopropylidenediphenol"|chemical == "Decabromodiphenyl oxide"|chemical == "Chromium" | chemical == "Chromium compounds"|chemical == "Cyanide compounds" | chemical == "Hydrogen cyanide"|chemical == "Lead" | chemical == "Lead compounds"|chemical == "Styrene")

```



#add groupings to baseline vulnerability dfs so I can add back into one big df
```{r}
baseline_carc$endpoint = "carc"
baseline_cardio$endpoint = "cardio"
baseline_CNS$endpoint = "CNS"
baseline_edc$endpoint = "edcs"
baseline_lkt$endpoint = "lkt"

all_baseline = rbind(baseline_carc, baseline_cardio, baseline_CNS, baseline_edc, baseline_lkt)

tri_cvi_baseline = merge(tri_cvi, all_baseline[,c("chemical", "endpoint")], by = "chemical")
```


#summary and stats to compare between end groups and graph
```{r}
tri_cvi_aov_baseline = aov(Baseline.Vulnerabilities ~ endpoint, data = tri_cvi_baseline)
tri_cvi_aov_baseline
tri_cvi_tukey_baseline = TukeyHSD(x = tri_cvi_aov_baseline, conf.level = 0.95)
tri_cvi_tukey_baseline
capture.output(tri_cvi_tukey_baseline, file = "~/TSCA/CRA/CRA_Prioritization/Output/tri_cvi_tukey")

#Violin plot
endpoints = c("Carcinogens", "Cardiorespiratory", "CNS", "EDCs", "Liver, Kidney, Thyroid")
yvar = mean(tri_cvi_baseline$Baseline.Vulnerabilities)

tri_cvi_violin_baseline = ggplot(tri_cvi_baseline, aes(x = endpoint, y = Baseline.Vulnerabilities)) + geom_violin(trim = FALSE) + theme_bw() + ylab("Baseline Vulnerability") + xlab("Endpoint Group") + scale_x_discrete(labels = endpoints) + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = yvar, linetype = "dashed") + scale_fill_viridis(discrete = TRUE, begin=.4)

tri_cvi_violin_baseline

ggsave(filename = "tri_cvi_violin_baseline.png", device = "png", plot = tri_cvi_violin_baseline, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 10, height = 5)

```


#filter tri_cvi_baseline for each endpoint group (without summary numbers, like above in baseline_endpoint dfs)
```{r}
cvi_CNS = filter(tri_cvi, chemical == "Acetaldehyde" | chemical == "Acrylonitrile"|chemical == "Aniline"|chemical == "Styrene"|chemical == "Benzene"|chemical == "Bromoform"|chemical == "Vinyl chloride"|chemical =="Arsenic"|chemical =="Arsenic compounds"|chemical == "Cyanide compounds" | chemical == "Hydrogen cyanide" |  chemical == "Ethylbenzene" | chemical == "m-Xylene" | chemical == "o-Xylene" | chemical == "p-Xylene" | chemical == "Xylene (mixed isomers)"| chemical =="Decabromodiphenyl oxide"| chemical == "Lead"| chemical == "Lead compounds")

cvi_carc = filter(tri_cvi, chemical == "Acetaldehyde" | chemical == "Acrylonitrile"|chemical == "Aniline"|chemical == "Styrene"|chemical == "Benzene"|chemical == "Bromoform"|chemical == "Vinyl chloride"|chemical == "Creosote"|chemical == "3,3'-Dichlorobenzidine"|chemical == "3,3'-Dichlorobenzidine dihydrochloride"|chemical == "4,4'-Methylenebis(2-chloroaniline)"|chemical == "N-Nitrosodiphenylamine"|chemical == "Cadmium" | chemical == "Cadmium compounds"|chemical == "Nickel" | chemical == "Nickel compounds"|chemical == "Arsenic" | chemical == "Arsenic compounds"|chemical == "Chromium" | chemical == "Chromium compounds"|chemical == "Lead" | chemical == "Lead compounds")

cvi_cardio = filter(tri_cvi, chemical == "Barium" | chemical == "Barium compounds"|chemical == "Cobalt" | chemical == "Cobalt compounds"|chemical == "Molybdenum trioxide"|chemical == "Naphthalene"|chemical == "Maleic anhydride"|chemical == "1-Hexadecanol"|chemical == "Hydrogen fluoride"|chemical == "Acetaldehyde" | chemical == "Acrylonitrile"|chemical == "Arsenic" | chemical == "Arsenic compounds"|chemical == "Aniline"|chemical == "Cadmium" | chemical == "Cadmium compounds"|chemical == "Chromium" | chemical == "Chromium compounds"|chemical =="Ethylbenzene"|chemical == "Nickel" | chemical == "Nickel compounds") 

cvi_lkt = filter(tri_cvi, chemical == "Hexachloro-1,3-butadiene"|chemical == "Maleic anhydride"|chemical == "4,4'-Methylenebis(2-chloroaniline)"|chemical == "Cadmium" | chemical == "Cadmium compounds"|chemical == "Creosote"|chemical =="Ethylbenzene"|chemical == "Lead" | chemical == "Lead compounds"|chemical == "Molybdenum trioxide"|chemical == "Styrene"|chemical == "Bromoform"|chemical == "Vinyl chloride")

cvi_edcs = filter(tri_cvi, chemical == "Nonylphenol" | chemical == "Nonylphenol Ethoxylates"|chemical == "4,4'-Isopropylidenediphenol"|chemical == "Decabromodiphenyl oxide"|chemical == "Chromium" | chemical == "Chromium compounds"|chemical == "Cyanide compounds" | chemical == "Hydrogen cyanide"|chemical == "Lead" | chemical == "Lead compounds"|chemical == "Styrene")
```


#violin for baseline vulnerability of each chemical within endpoint groups
```{r}
#carcinogens
carc_violin_baseline = ggplot(cvi_carc, aes(x = chemical, y = Baseline.Vulnerabilities)) + geom_violin(trim = FALSE) + theme_bw() + ylab("Baseline Vulnerability") + xlab("Chemical") + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = mean(cvi_carc$Baseline.Vulnerabilities), linetype = "dashed")  + scale_y_continuous(breaks = seq(0.2, 0.8, 0.1), limits = c(0.2,0.8))

carc_violin_baseline

ggsave(filename = "carc_violin_baseline.png", device = "png", plot = carc_violin_baseline, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 14, height = 5)

#CNS
CNS_violin_baseline = ggplot(cvi_CNS, aes(x = chemical, y = Baseline.Vulnerabilities)) + geom_violin(trim = FALSE) + theme_bw() + ylab("Baseline Vulnerability") + xlab("Chemical") + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = mean(cvi_carc$Baseline.Vulnerabilities), linetype = "dashed")  + scale_y_continuous(breaks = seq(0.2, 0.8, 0.1), limits = c(0.2,0.8))

CNS_violin_baseline

ggsave(filename = "CNS_violin_baseline.png", device = "png", plot = CNS_violin_baseline, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 10, height = 5)

#cardiorespiratory
cardio_violin_baseline = ggplot(cvi_cardio, aes(x = chemical, y = Baseline.Vulnerabilities)) + geom_violin(trim = FALSE) + theme_bw() + ylab("Baseline Vulnerability") + xlab("Chemical") + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = mean(cvi_carc$Baseline.Vulnerabilities), linetype = "dashed")  + scale_y_continuous(breaks = seq(0.2, 0.8, 0.1), limits = c(0.2,0.8))

cardio_violin_baseline

ggsave(filename = "cardio_violin_baseline.png", device = "png", plot = cardio_violin_baseline, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 10, height = 5)

#EDCs
edcs_violin_baseline = ggplot(cvi_edcs, aes(x = chemical, y = Baseline.Vulnerabilities)) + geom_violin(trim = FALSE) + theme_bw() + ylab("Baseline Vulnerability") + xlab("Chemical") + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = mean(cvi_carc$Baseline.Vulnerabilities), linetype = "dashed")  + scale_y_continuous(breaks = seq(0.2, 0.8, 0.1), limits = c(0.2,0.8))

edcs_violin_baseline

ggsave(filename = "edcs_violin_baseline.png", device = "png", plot = edcs_violin_baseline, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 10, height = 5)

#liver, kidney, thyroid
lkt_violin_baseline = ggplot(cvi_lkt, aes(x = chemical, y = Baseline.Vulnerabilities)) + geom_violin(trim = FALSE) + theme_bw() + ylab("Baseline Vulnerability") + xlab("Chemical") + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = mean(cvi_carc$Baseline.Vulnerabilities), linetype = "dashed")  + scale_y_continuous(breaks = seq(0.2, 0.8, 0.1), limits = c(0.2,0.8))

lkt_violin_baseline

ggsave(filename = "lkt_violin_baseline.png", device = "png", plot = lkt_violin_baseline, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 10, height = 5)
```


#repeat everything we did with baseline for climate vulnerability index to see where climate might have an impact (want to do just for climate or overall cvi? doing for overall cvi for now)


#Get average CVI score for each chemical and endpoint group
```{r}
cvi_bychem = summarySE(tri_cvi, groupvars = "chemical", measurevar = "CVI.Score")

#CNS chemicals
cvi_CNS = filter(cvi_bychem, chemical == "Acetaldehyde" | chemical == "Acrylonitrile"|chemical == "Aniline"|chemical == "Styrene"|chemical == "Benzene"|chemical == "Bromoform"|chemical == "Vinyl chloride"|chemical =="Arsenic"|chemical =="Arsenic compounds"|chemical == "Cyanide compounds" | chemical == "Hydrogen cyanide" |  chemical == "Ethylbenzene" | chemical == "m-Xylene" | chemical == "o-Xylene" | chemical == "p-Xylene" | chemical == "Xylene (mixed isomers)"| chemical =="Decabromodiphenyl oxide"| chemical == "Lead"| chemical == "Lead compounds")

#Carcinogens
cvi_carc = filter(cvi_bychem, chemical == "Acetaldehyde" | chemical == "Acrylonitrile"|chemical == "Aniline"|chemical == "Styrene"|chemical == "Benzene"|chemical == "Bromoform"|chemical == "Vinyl chloride"|chemical == "Creosote"|chemical == "3,3'-Dichlorobenzidine"|chemical == "3,3'-Dichlorobenzidine dihydrochloride"|chemical == "4,4'-Methylenebis(2-chloroaniline)"|chemical == "N-Nitrosodiphenylamine"|chemical == "Cadmium" | chemical == "Cadmium compounds"|chemical == "Nickel" | chemical == "Nickel compounds"|chemical == "Arsenic" | chemical == "Arsenic compounds"|chemical == "Chromium" | chemical == "Chromium compounds"|chemical == "Lead" | chemical == "Lead compounds")

#cardiorespiratory
cvi_cardio = filter(cvi_bychem, chemical == "Barium" | chemical == "Barium compounds"|chemical == "Cobalt" | chemical == "Cobalt compounds"|chemical == "Molybdenum trioxide"|chemical == "Naphthalene"|chemical == "Maleic anhydride"|chemical == "1-Hexadecanol"|chemical == "Hydrogen fluoride"|chemical == "Acetaldehyde" | chemical == "Acrylonitrile"|chemical == "Arsenic" | chemical == "Arsenic compounds"|chemical == "Aniline"|chemical == "Cadmium" | chemical == "Cadmium compounds"|chemical == "Chromium" | chemical == "Chromium compounds"|chemical =="Ethylbenzene"|chemical == "Nickel" | chemical == "Nickel compounds") 

#liver, kidney, thyroid
cvi_lkt = filter(cvi_bychem, chemical == "Hexachloro-1,3-butadiene"|chemical == "Maleic anhydride"|chemical == "4,4'-Methylenebis(2-chloroaniline)"|chemical == "Cadmium" | chemical == "Cadmium compounds"|chemical == "Creosote"|chemical =="Ethylbenzene"|chemical == "Lead" | chemical == "Lead compounds"|chemical == "Molybdenum trioxide"|chemical == "Styrene"|chemical == "Bromoform"|chemical == "Vinyl chloride")

#edcs
cvi_edcs = filter(cvi_bychem, chemical == "Nonylphenol" | chemical == "Nonylphenol Ethoxylates"|chemical == "4,4'-Isopropylidenediphenol"|chemical == "Decabromodiphenyl oxide"|chemical == "Chromium" | chemical == "Chromium compounds"|chemical == "Cyanide compounds" | chemical == "Hydrogen cyanide"|chemical == "Lead" | chemical == "Lead compounds"|chemical == "Styrene")

```


#add groupings to climate vulnerability index dfs so I can add back into one big df
```{r}
cvi_carc$endpoint = "carc"
cvi_cardio$endpoint = "cardio"
cvi_CNS$endpoint = "CNS"
cvi_edcs$endpoint = "edcs"
cvi_lkt$endpoint = "lkt"

all_cvi = rbind(cvi_carc, cvi_cardio, cvi_CNS, cvi_edcs, cvi_lkt)

tri_cvi = merge(tri_cvi, all_cvi[,c("chemical", "endpoint")], by = "chemical")
```


#summary and stats to compare between end groups and graph for climate vulnerability index
```{r}
tri_cvi_aov = aov(CVI.Score ~ endpoint, data = tri_cvi)
tri_cvi_aov
tri_cvi_tukey = TukeyHSD(x = tri_cvi_aov, conf.level = 0.95)
tri_cvi_tukey
capture.output(tri_cvi_tukey, file = "~/TSCA/CRA/CRA_Prioritization/Output/tri_cvi_tukey")

#Violin plot
endpoints = c("Carcinogens", "Cardiorespiratory", "CNS", "EDCs", "Liver, Kidney, Thyroid")
yvar = mean(tri_cvi$CVI.Score)

tri_cvi_violin = ggplot(tri_cvi, aes(x = endpoint, y = CVI.Score)) + geom_violin(trim = FALSE) + theme_bw() + ylab("CVI Score") + xlab("Endpoint Group") + scale_x_discrete(labels = endpoints) + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = yvar, linetype = "dashed") + scale_fill_viridis(discrete = TRUE, begin=.4)

tri_cvi_violin

ggsave(filename = "tri_cvi_violin.png", device = "png", plot = tri_cvi_violin, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 10, height = 5)

#Summary values
tri_cvi_summary = summarySE(tri_cvi, measurevar = "CVI.Score", groupvars = "endpoint")

write.csv(tri_cvi_summary, file = "~/TSCA/CRA/CRA_Prioritization/Output/tri_cvi_summary.csv")
```


#filter tri_cvi for each endpoint group (without summary numbers, like above in cvi_endpoint dfs)
```{r}
cvi_CNS = filter(tri_cvi, chemical == "Acetaldehyde" | chemical == "Acrylonitrile"|chemical == "Aniline"|chemical == "Styrene"|chemical == "Benzene"|chemical == "Bromoform"|chemical == "Vinyl chloride"|chemical =="Arsenic"|chemical =="Arsenic compounds"|chemical == "Cyanide compounds" | chemical == "Hydrogen cyanide" |  chemical == "Ethylbenzene" | chemical == "m-Xylene" | chemical == "o-Xylene" | chemical == "p-Xylene" | chemical == "Xylene (mixed isomers)"| chemical =="Decabromodiphenyl oxide"| chemical == "Lead"| chemical == "Lead compounds")

cvi_carc = filter(tri_cvi, chemical == "Acetaldehyde" | chemical == "Acrylonitrile"|chemical == "Aniline"|chemical == "Styrene"|chemical == "Benzene"|chemical == "Bromoform"|chemical == "Vinyl chloride"|chemical == "Creosote"|chemical == "3,3'-Dichlorobenzidine"|chemical == "3,3'-Dichlorobenzidine dihydrochloride"|chemical == "4,4'-Methylenebis(2-chloroaniline)"|chemical == "N-Nitrosodiphenylamine"|chemical == "Cadmium" | chemical == "Cadmium compounds"|chemical == "Nickel" | chemical == "Nickel compounds"|chemical == "Arsenic" | chemical == "Arsenic compounds"|chemical == "Chromium" | chemical == "Chromium compounds"|chemical == "Lead" | chemical == "Lead compounds")

cvi_cardio = filter(tri_cvi, chemical == "Barium" | chemical == "Barium compounds"|chemical == "Cobalt" | chemical == "Cobalt compounds"|chemical == "Molybdenum trioxide"|chemical == "Naphthalene"|chemical == "Maleic anhydride"|chemical == "1-Hexadecanol"|chemical == "Hydrogen fluoride"|chemical == "Acetaldehyde" | chemical == "Acrylonitrile"|chemical == "Arsenic" | chemical == "Arsenic compounds"|chemical == "Aniline"|chemical == "Cadmium" | chemical == "Cadmium compounds"|chemical == "Chromium" | chemical == "Chromium compounds"|chemical =="Ethylbenzene"|chemical == "Nickel" | chemical == "Nickel compounds") 

cvi_lkt = filter(tri_cvi, chemical == "Hexachloro-1,3-butadiene"|chemical == "Maleic anhydride"|chemical == "4,4'-Methylenebis(2-chloroaniline)"|chemical == "Cadmium" | chemical == "Cadmium compounds"|chemical == "Creosote"|chemical =="Ethylbenzene"|chemical == "Lead" | chemical == "Lead compounds"|chemical == "Molybdenum trioxide"|chemical == "Styrene"|chemical == "Bromoform"|chemical == "Vinyl chloride")

cvi_edcs = filter(tri_cvi, chemical == "Nonylphenol" | chemical == "Nonylphenol Ethoxylates"|chemical == "4,4'-Isopropylidenediphenol"|chemical == "Decabromodiphenyl oxide"|chemical == "Chromium" | chemical == "Chromium compounds"|chemical == "Cyanide compounds" | chemical == "Hydrogen cyanide"|chemical == "Lead" | chemical == "Lead compounds"|chemical == "Styrene")
```


#violin for climate vulnerability of each chemical within endpoint groups
```{r}
#carcinogens
carc_violin_cvi = ggplot(cvi_carc, aes(x = chemical, y = CVI.Score)) + geom_violin(trim = FALSE) + theme_bw() + ylab("CVI Score") + xlab("Chemical") + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = mean(cvi_carc$CVI.Score), linetype = "dashed")  + scale_y_continuous(breaks = seq(0.2, 0.8, 0.1), limits = c(0.2,0.8))

carc_violin_cvi

ggsave(filename = "carc_violin_cvi.png", device = "png", plot = carc_violin_cvi, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 14, height = 5)

#CNS
CNS_violin_cvi = ggplot(cvi_CNS, aes(x = chemical, y = CVI.Score)) + geom_violin(trim = FALSE) + theme_bw() + ylab("CVI Score") + xlab("Chemical") + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = mean(cvi_CNS$CVI.Score), linetype = "dashed")  + scale_y_continuous(breaks = seq(0.2, 0.8, 0.1), limits = c(0.2,0.8))

CNS_violin_cvi

ggsave(filename = "CNS_violin_cvi.png", device = "png", plot = CNS_violin_cvi, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 10, height = 5)

#cardiorespiratory
cardio_violin_cvi = ggplot(cvi_cardio, aes(x = chemical, y = CVI.Score)) + geom_violin(trim = FALSE) + theme_bw() + ylab("CVI Score") + xlab("Chemical") + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = mean(cvi_cardio$CVI.Score), linetype = "dashed")  + scale_y_continuous(breaks = seq(0.2, 0.8, 0.1), limits = c(0.2,0.8))

cardio_violin_cvi

ggsave(filename = "cardio_violin_cvi.png", device = "png", plot = cardio_violin_cvi, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 10, height = 5)

#EDCs
edcs_violin_cvi = ggplot(cvi_edcs, aes(x = chemical, y = CVI.Score)) + geom_violin(trim = FALSE) + theme_bw() + ylab("CVI Score") + xlab("Chemical") + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = mean(cvi_edcs$CVI.Score), linetype = "dashed")  + scale_y_continuous(breaks = seq(0.2, 0.8, 0.1), limits = c(0.2,0.8))

edcs_violin_cvi

ggsave(filename = "edcs_violin_cvi.png", device = "png", plot = edcs_violin_cvi, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 10, height = 5)

#liver, kidney, thyroid
lkt_violin_cvi = ggplot(cvi_lkt, aes(x = chemical, y = CVI.Score)) + geom_violin(trim = FALSE) + theme_bw() + ylab("CVI Score") + xlab("Chemical") + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = mean(cvi_lkt$CVI.Score), linetype = "dashed")  + scale_y_continuous(breaks = seq(0.2, 0.8, 0.1), limits = c(0.2,0.8))

lkt_violin_cvi

ggsave(filename = "lkt_violin_cvi.png", device = "png", plot = lkt_violin_cvi, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 10, height = 5)
```


#violin plots for Baseline Vulnerability - Environment by chemical in each endpoint group (most relevant for cumulative exposures)

```{r}
#carcinogens
carc_violin_env = ggplot(cvi_carc, aes(x = chemical, y = Baseline.Vulnerability..Enviroment)) + geom_violin(trim = FALSE) + theme_bw() + ylab("Environmental Vulnerability") + xlab("Chemical") + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = mean(cvi_carc$Baseline.Vulnerability..Enviroment), linetype = "dashed")  + scale_y_continuous(breaks = seq(0.2, 0.8, 0.1), limits = c(0.2,0.8))

carc_violin_env

ggsave(filename = "carc_violin_env.png", device = "png", plot = carc_violin_env, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 14, height = 5)

#CNS
CNS_violin_env = ggplot(cvi_CNS, aes(x = chemical, y = Baseline.Vulnerability..Enviroment)) + geom_violin(trim = FALSE) + theme_bw() + ylab("Environmental Vulnerability") + xlab("Chemical") + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = mean(cvi_CNS$Baseline.Vulnerability..Enviroment), linetype = "dashed")  + scale_y_continuous(breaks = seq(0.2, 0.8, 0.1), limits = c(0.2,0.8))

CNS_violin_env

ggsave(filename = "CNS_violin_env.png", device = "png", plot = CNS_violin_env, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 10, height = 5)

#cardiorespiratory
cardio_violin_env = ggplot(cvi_cardio, aes(x = chemical, y = Baseline.Vulnerability..Enviroment)) + geom_violin(trim = FALSE) + theme_bw() + ylab("Environmental Vulnerability") + xlab("Chemical") + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = mean(cvi_cardio$Baseline.Vulnerability..Enviroment), linetype = "dashed")  + scale_y_continuous(breaks = seq(0.2, 0.8, 0.1), limits = c(0.2,0.8))

cardio_violin_env

ggsave(filename = "cardio_violin_env.png", device = "png", plot = cardio_violin_env, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 10, height = 5)

#EDCs
edcs_violin_env = ggplot(cvi_edcs, aes(x = chemical, y = Baseline.Vulnerability..Enviroment)) + geom_violin(trim = FALSE) + theme_bw() + ylab("Environmental Vulnerability") + xlab("Chemical") + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1)) + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = mean(cvi_edcs$Baseline.Vulnerability..Enviroment), linetype = "dashed")  + scale_y_continuous(breaks = seq(0.2, 0.8, 0.1), limits = c(0.2,0.8))

edcs_violin_env

ggsave(filename = "edcs_violin_env.png", device = "png", plot = edcs_violin_env, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 10, height = 5)

#liver, kidney, thyroid
lkt_violin_env = ggplot(cvi_lkt, aes(x = chemical, y = Baseline.Vulnerability..Enviroment, fill = chemical)) + geom_violin(trim = FALSE) + theme_bw() + ylab("Environmental Vulnerability") + xlab("Chemical") + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1), legend.position = "none") + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = mean(cvi_lkt$Baseline.Vulnerability..Enviroment), linetype = "dashed")  + scale_y_continuous(breaks = seq(0.2, 0.8, 0.1), limits = c(0.2,0.8)) + scale_fill_viridis(discrete = TRUE, begin = .4)

lkt_violin_env

ggsave(filename = "lkt_violin_env.png", device = "png", plot = lkt_violin_env, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 10, height = 5)
```

#summary and stats to compare between end groups and graph for baseline vulnerability - environment
```{r}
tri_env_aov = aov(Baseline.Vulnerability..Enviroment ~ endpoint, data = tri_cvi)
tri_env_aov
tri_env_tukey = TukeyHSD(x = tri_cvi_aov, conf.level = 0.95)
tri_env_tukey
capture.output(tri_env_tukey, file = "~/TSCA/CRA/CRA_Prioritization/Output/tri_env_tukey")

#Violin plot
endpoints = c("Carcinogens", "Cardiorespiratory", "CNS", "EDCs", "Liver, Kidney, Thyroid")
yvar = mean(tri_cvi$Baseline.Vulnerability..Enviroment)

tri_env_violin = ggplot(tri_cvi, aes(x = endpoint, y = Baseline.Vulnerability..Enviroment)) + geom_violin(trim = FALSE) + theme_bw() + ylab("Environmental Vulnerability") + xlab("Endpoint Group") + scale_x_discrete(labels = endpoints) + theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1), legend.position = "none") + stat_summary(fun = mean, geom = "point", shape = 20, size = 5, color = "black", fill = "gray") + geom_hline(yintercept = yvar, linetype = "dashed") 

tri_env_violin

ggsave(filename = "tri_env_violin.png", device = "png", plot = tri_env_violin, path = "~/TSCA/CRA/CRA_Prioritization/Output/", width = 10, height = 5)

#Summary values
tri_env_summary = summarySE(tri_cvi, measurevar = "Baseline.Vulnerability..Enviroment", groupvars = "endpoint")

write.csv(tri_env_summary, file = "~/TSCA/CRA/CRA_Prioritization/Output/tri_env_summary.csv")
```















